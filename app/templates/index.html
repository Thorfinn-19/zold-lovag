<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Z√∂ld Lovag ‚Äì Bejelent√©s</title>

  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    #map { width: 100%; height: 420px; border: 1px solid #ccc; border-radius: 8px; }
    .row { display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap; }
    .field { display: flex; flex-direction: column; gap: 6px; min-width: 220px; flex: 1; }
    input, textarea { padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
    textarea { min-height: 120px; resize: vertical; }
    button { padding: 12px 16px; border: 0; border-radius: 8px; cursor: pointer; }
    .actions { margin-top: 12px; }
    .hint { color: #666; font-size: 0.9rem; margin-top: 6px; }
  </style>
</head>
<body>
  <h1>Illeg√°lis hullad√©k bejelent√©s</h1>
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div style="margin: 12px 0;">
        {% for category, msg in messages %}
          <div style="
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #ccc;
          ">
            {{ msg }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}


  <div id="map"></div>
  <div class="hint">Kattints a t√©rk√©pre: a koordin√°t√°k automatikusan kit√∂lt≈ëdnek.</div>

  <form method="POST" action="/bejelentes" enctype="multipart/form-data">
    <div class="row">
      <div class="field">
        <label for="koord_szel">Sz√©less√©g (lat)</label>
        <input id="koord_szel" name="koord_szel" type="text" placeholder="pl. 47.687123" readonly style="background:#f3f3f3;"/>
      </div>

      <div class="field">
        <label for="koord_hossz">Hossz√∫s√°g (lng)</label>
        <input id="koord_hossz" name="koord_hossz" type="text" placeholder="pl. 17.650456" readonly style="background:#f3f3f3;"/>
      </div>

      <div class="actions">
        <button type="button" id="btn-clear-coords">Koordin√°t√°k t√∂rl√©se</button>
      </div>

      <div class="field">
        <label for="cim">C√≠m</label>
        <input id="cim" name="cim" type="text" placeholder="pl. Gy≈ër, ... utca ..." />
      </div>
    </div>

    <div class="row">
      <div class="field" style="min-width: 320px; flex: 2;">
        <label for="leiras">Le√≠r√°s</label>
        <textarea id="leiras" name="leiras" placeholder="√çrd le r√∂viden, mit l√°tsz, kb. mennyis√©g, vesz√©ly, stb."></textarea>
      </div>

      <div class="field">
        <label for="foto">K√©p felt√∂lt√©s</label>
        <input id="foto" name="foto" type="file" accept="image/*" />
      </div>
    </div>

    <div class="actions">
      <button type="submit">Bejelent√©s k√ºld√©se</button>
    </div>
  </form>

<script>
  let map;
  let marker;

  function initMap() {
    const startPos = { lat: 47.687, lng: 17.650 }; // Gy≈ër k√∂rny√©ke
    map = new google.maps.Map(document.getElementById("map"), {
      center: startPos,
      zoom: 12,
    });

    // Kattint√°s a t√©rk√©pen ‚Üí koordin√°t√°k kit√∂lt√©se
    map.addListener("click", (e) => {
      const lat = e.latLng.lat().toFixed(6);
      const lng = e.latLng.lng().toFixed(6);

      document.getElementById("koord_szel").value = lat;
      document.getElementById("koord_hossz").value = lng;

      if (marker) marker.setMap(null);
      marker = new google.maps.Marker({
        position: { lat: parseFloat(lat), lng: parseFloat(lng) },
        map: map,
      });
    });

    // üîΩ IDE J√ñN A 3) R√âSZ üîΩ
    const clearBtn = document.getElementById("btn-clear-coords");
    if (clearBtn) {
      clearBtn.addEventListener("click", () => {
        document.getElementById("koord_szel").value = "";
        document.getElementById("koord_hossz").value = "";

        if (marker) {
          marker.setMap(null);
          marker = null;
        }
      });
    }
  }

  window.initMap = initMap;
</script>


  <script async defer
  src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_key }}&callback=initMap"> //API kulcs itt
</script>


  <hr style="margin: 18px 0;">

<div class="actions">
  <button type="button" id="btn-load">Kor√°bbi bejelent√©sek megtekint√©se</button>
</div>

<div id="reports" style="margin-top: 12px; display:none;">
  <h2>Kor√°bbi bejelent√©sek</h2>
  <div id="reports-status" class="hint"></div>

  <div style="overflow:auto; border:1px solid #ccc; border-radius:8px;">
    <table style="width:100%; border-collapse:collapse; min-width: 900px;">
      <thead>
        <tr>
          <th style="text-align:left; padding:8px; border-bottom:1px solid #ccc;">ID</th>
          <th style="text-align:left; padding:8px; border-bottom:1px solid #ccc;">D√°tum/id≈ë</th>
          <th style="text-align:left; padding:8px; border-bottom:1px solid #ccc;">C√≠m</th>
          <th style="text-align:left; padding:8px; border-bottom:1px solid #ccc;">Sz√©l</th>
          <th style="text-align:left; padding:8px; border-bottom:1px solid #ccc;">Hossz</th>
          <th style="text-align:left; padding:8px; border-bottom:1px solid #ccc;">St√°tusz</th>
          <th style="text-align:left; padding:8px; border-bottom:1px solid #ccc;">Priorit√°s</th>
          <th style="text-align:left; padding:8px; border-bottom:1px solid #ccc;">T√≠pus</th>
          <th style="text-align:left; padding:8px; border-bottom:1px solid #ccc;">Mennyis√©g</th>
        </tr>
      </thead>
      <tbody id="reports-body"></tbody>
    </table>
  </div>
</div>

<script>
  const btn = document.getElementById("btn-load");
  const box = document.getElementById("reports");
  const statusEl = document.getElementById("reports-status");
  const bodyEl = document.getElementById("reports-body");

  let loaded = false;

  function escapeHtml(s) {
    if (s === null || s === undefined) return "";
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  btn.addEventListener("click", async () => {
    box.style.display = (box.style.display === "none") ? "block" : "none";
    if (box.style.display === "none") return;

    if (loaded) return;

    statusEl.textContent = "Bet√∂lt√©s...";
    bodyEl.innerHTML = "";

    try {
      const res = await fetch("/bejelentesek");
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();

      if (!data.length) {
        statusEl.textContent = "Nincs m√©g bejelent√©s.";
        loaded = true;
        return;
      }

      const rows = data.map(b => `
        <tr>
          <td style="padding:8px; border-bottom:1px solid #eee;">${escapeHtml(b.bejelentesID)}</td>
          <td style="padding:8px; border-bottom:1px solid #eee;">${escapeHtml(b.datum_ido)}</td>
          <td style="padding:8px; border-bottom:1px solid #eee;">${escapeHtml(b.cim)}</td>
          <td style="padding:8px; border-bottom:1px solid #eee;">${escapeHtml(b.koord_szel)}</td>
          <td style="padding:8px; border-bottom:1px solid #eee;">${escapeHtml(b.koord_hossz)}</td>
          <td style="padding:8px; border-bottom:1px solid #eee;">${escapeHtml(b.statusz)}</td>
          <td style="padding:8px; border-bottom:1px solid #eee;">${escapeHtml(b.prioritas)}</td>
          <td style="padding:8px; border-bottom:1px solid #eee;">${escapeHtml(b.hulladek_tipus)}</td>
          <td style="padding:8px; border-bottom:1px solid #eee;">${escapeHtml(b.mennyiseg)}</td>
        </tr>
      `).join("");

      bodyEl.innerHTML = rows;
      statusEl.textContent = `Megjelen√≠tve: ${data.length} bejelent√©s`;
      loaded = true;
    } catch (e) {
      statusEl.textContent = "Hiba a bet√∂lt√©sn√©l. (N√©zd meg a konzolt.)";
      console.error(e);
    }
  });
</script>

</body>
</html>
